# Story 5.3: Logg inntak

## Status
**Ready for Development** (v2.0 - Refined by Bob SM, 2025-10-27)

## Story
**As a** user in an active session (Story 5.1),
**I want** to log fuel intake with one tap on a large button,
**so that** I can track what I consume during my workout without interrupting my training.

## Acceptance Criteria

### AC1: Display Next Planned Intake (Planned Session)
**Given** user is in an active session with a fuel plan (from Story 4.2-4.3)
**When** ActiveSessionScreen is displayed
**Then** show "Neste inntak" card above the "INNTAK" button:
- Product name (e.g., "Maurten Gel 100")
- Planned time (e.g., "om 3 min" or "KLART NÅ" if within ±2 min window)
- Carbs amount (e.g., "25g")

**Edge case:** If all planned intakes are logged, show "Ingen flere planlagte inntak"

### AC2: Log Planned Intake (Quick Log)
**Given** user has a planned intake shown
**When** user taps the large "INNTAK" button
**Then**:
- Create session_event in database:
  - `event_type`: 'intake'
  - `timestamp_offset_seconds`: elapsed seconds from session start
  - `actual_timestamp`: current datetime (ISO 8601)
  - `data_json`: `{ fuel_product_id, product_name, quantity, carbs_consumed, was_planned: true }`
- Show Snackbar toast: "✓ Maurten Gel loggført (25g)"
- Auto-dismiss toast after 2 seconds
- Update "Neste inntak" to show next item in plan

### AC3: Log Unplanned Intake (Product Selector)
**Given** user is in a spontaneous session (no fuel plan) OR all planned intakes are logged
**When** user taps "INNTAK" button
**Then**:
- Show bottom sheet with product list (from user's Skafferi)
- User selects product → same as AC2 but `was_planned: false`
- Quantity defaults to 1 (no quantity selector in MVP)

### AC4: Display Intake Log
**Given** user has logged intake events
**Then** show scrollable list at bottom of screen:
- Format: "00:25 - ✓ Maurten Gel (25g)"
- Most recent at top
- Max 5 visible, scroll for more
- Color: Green checkmark (✓)

### AC5: Calculate Timestamp Offset
**Given** session started at time T0
**When** user logs intake at time T1
**Then** `timestamp_offset_seconds = (T1 - T0) in seconds`

**Example:** Session started 10:00:00, intake logged 10:25:30 → offset = 1530 seconds

## Out of Scope (Future Stories)
- ❌ Quantity selector (MVP: always quantity = 1)
- ❌ Edit/delete logged events (future enhancement)
- ❌ Intake notifications/reminders (Story 5.2)
- ❌ Manual timestamp adjustment (future enhancement)
- ❌ Photos of products (future epic)
- ❌ Intake analytics (Epic 7)

## Tasks / Subtasks

### Backend
- [ ] Create `src/database/repositories/SessionEventRepository.ts`
- [ ] Implement `createIntakeEvent(sessionLogId, offsetSeconds, data)` - INSERT into session_events
- [ ] Implement `getEventsBySession(sessionLogId, eventType?)` - retrieve events
- [ ] Add TypeScript types: `SessionEvent`, `IntakeEventData`
- [ ] Export from `src/database/repositories/index.ts`

### ActiveSessionScreen Updates
- [ ] Add state: `intakeEvents`, `fuelPlan`, `nextPlannedIntake`
- [ ] Load fuel plan from `planned_sessions.fuel_plan_json` (if exists)
- [ ] Calculate next planned intake based on timer + logged events
- [ ] Add "Neste inntak" card component (conditional render)
- [ ] Update "INNTAK" button from disabled placeholder to functional
- [ ] Implement `handleLogIntake()`:
  - If planned: Quick log with plan data
  - If unplanned: Show product selector bottom sheet
- [ ] Add Snackbar for success toast
- [ ] Add SessionEventList component at bottom

### Components
- [ ] Create `src/components/session/NextIntakeCard.tsx`
  - Display product name, time remaining, carbs
  - Show "KLART NÅ" badge if within ±2 min
- [ ] Create `src/components/session/SessionEventList.tsx`
  - Scrollable FlatList with max 5 visible
  - Format: "HH:MM - ✓ Product (Xg)"
  - Green checkmark for intake events

### Product Selector (Unplanned)
- [ ] Create `src/components/session/ProductSelectorSheet.tsx`
- [ ] Use react-native-paper BottomSheet or Portal + Modal
- [ ] Load products from FuelProductRepository
- [ ] Handle product selection → log intake

### Testing
- [ ] Test planned intake quick log flow
- [ ] Test unplanned intake with product selector
- [ ] Test "Neste inntak" updates after logging
- [ ] Test intake event list display (multiple events)
- [ ] Test timestamp offset calculation accuracy
- [ ] Check database: session_events populated correctly
- [ ] Run `npm run type-check` - ensure no errors

## Dev Notes

### Database Schema (Already Exists)
See Migration 1 - table `session_events` already created.

### SessionEventRepository Interface
```typescript
// src/database/repositories/SessionEventRepository.ts
import { getDatabase } from '../index';

export interface SessionEvent {
  id: number;
  session_log_id: number;
  event_type: 'intake' | 'discomfort' | 'note';
  timestamp_offset_seconds: number;
  actual_timestamp: string;
  data_json: string; // Serialized JSON
  created_at: string;
}

export interface IntakeEventData {
  fuel_product_id: number;
  product_name: string;
  quantity: number;
  carbs_consumed: number;
  was_planned: boolean;
}

export class SessionEventRepository {
  static async createIntakeEvent(
    sessionLogId: number,
    offsetSeconds: number,
    data: IntakeEventData
  ): Promise<number> {
    const db = await getDatabase();
    const result = await db.runAsync(
      `INSERT INTO session_events
       (session_log_id, event_type, timestamp_offset_seconds, actual_timestamp, data_json)
       VALUES (?, 'intake', ?, datetime('now'), ?)`,
      [sessionLogId, offsetSeconds, JSON.stringify(data)]
    );
    return result.lastInsertRowId;
  }

  static async getEventsBySession(
    sessionLogId: number,
    eventType?: 'intake' | 'discomfort' | 'note'
  ): Promise<SessionEvent[]> {
    const db = await getDatabase();
    const query = eventType
      ? `SELECT * FROM session_events WHERE session_log_id = ? AND event_type = ? ORDER BY timestamp_offset_seconds ASC`
      : `SELECT * FROM session_events WHERE session_log_id = ? ORDER BY timestamp_offset_seconds ASC`;
    const params = eventType ? [sessionLogId, eventType] : [sessionLogId];
    const events = await db.getAllAsync<SessionEvent>(query, params);
    return events || [];
  }
}
```

### Calculating Next Planned Intake
```typescript
// ActiveSessionScreen.tsx
const getNextPlannedIntake = (
  fuelPlan: FuelPlanItem[],
  elapsedMinutes: number,
  loggedIntakes: SessionEvent[]
): FuelPlanItem | null => {
  // Filter out already logged intakes
  const loggedTimings = loggedIntakes
    .map(e => JSON.parse(e.data_json))
    .filter(d => d.was_planned)
    .map(d => d.timing_minute); // Assumes we store this

  // Find next unlogged intake
  for (const item of fuelPlan) {
    for (const timing of item.timing_minutes) {
      if (!loggedTimings.includes(timing) && timing >= elapsedMinutes - 2) {
        return { ...item, current_timing: timing };
      }
    }
  }
  return null;
};
```

### data_json Examples
**Planned intake:**
```json
{
  "fuel_product_id": 1,
  "product_name": "Maurten Gel 100",
  "quantity": 1,
  "carbs_consumed": 25,
  "was_planned": true
}
```

**Unplanned intake:**
```json
{
  "fuel_product_id": 3,
  "product_name": "SIS Gel",
  "quantity": 1,
  "carbs_consumed": 22,
  "was_planned": false
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story draft | Bob (SM) |
| 2025-10-27 | 2.0 | Refined with detailed ACs (AC1-5), MVP scope, SessionEventRepository interface, out of scope clarification, tasks breakdown, dev notes with examples | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
