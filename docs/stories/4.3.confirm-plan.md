# Story 4.3: Bekreft plan

## Status
**Ready for Development** (v1.1 - Refined by Bob SM, 2025-10-27)

## Story
**As a** user completing fuel plan selection (Story 4.2),
**I want** to save and confirm my nutrition plan,
**so that** I can start the session immediately or later.

## Acceptance Criteria

### AC1: Save Plan to Database
**Given** user has created a fuel plan in FuelSelectorScreen
**When** user taps "Bekreft plan" button
**Then** plan is saved to `planned_sessions` table with:
- `user_id`: 1 (hardcoded for MVP)
- `program_session_id`: sessionId from route params
- `planned_date`: current date/time (ISO 8601)
- `fuel_plan_json`: JSON.stringify(plan.items) from FuelPlan
- `notes`: null (for MVP)

### AC2: Show Success Feedback
**Given** plan saved successfully
**Then** show Snackbar toast: "✓ Plan lagret!"
**And** toast auto-dismisses after 3 seconds

### AC3: Prompt to Start Session
**Given** plan saved successfully
**When** toast appears
**Then** show Alert dialog:
- **Title**: "Start økten nå?"
- **Message**: "Vil du starte økten med denne planen?"
- **Buttons**:
  - "Start økt" → Navigate to SessionActive screen (Epic 5)
  - "Senere" → Navigate back to ProgramDetail screen

### AC4: Navigation - Start Session
**Given** user taps "Start økt" in dialog
**Then** navigate to `SessionActive` screen with params:
- `sessionId`: planned session ID (from database insert)

**Edge case:** If Epic 5 not implemented, show placeholder toast: "Økt-modus kommer i Epic 5" and navigate back.

### AC5: Navigation - Start Later
**Given** user taps "Senere" in dialog
**Then** navigate back to `ProgramDetail` screen

**Note:** Session status badge "⏳ Planlagt" and Dashboard updates deferred to Epic 5.

## Out of Scope (Future Stories)
- ❌ Edit saved plan (future: Story 4.4)
- ❌ Add notes field to plan
- ❌ Dashboard "Planned Sessions" widget (Epic 5)
- ❌ ProgramDetail status badge updates (Epic 5)

## Tasks / Subtasks

### Backend
- [ ] Create `src/database/repositories/PlannedSessionRepository.ts`
- [ ] Implement `create(data)` - insert into planned_sessions, return ID
- [ ] Implement `getById(id)` - retrieve planned session
- [ ] Add TypeScript types: `PlannedSession` interface
- [ ] Export from `src/database/repositories/index.ts`

### FuelSelectorScreen Updates
- [ ] Import PlannedSessionRepository
- [ ] Import Snackbar and Alert from react-native-paper
- [ ] Update `handleConfirmPlan()`:
  - [ ] Serialize plan.items to JSON
  - [ ] Call PlannedSessionRepository.create()
  - [ ] Show Snackbar: "✓ Plan lagret!"
  - [ ] Show Alert dialog "Start økten nå?"
  - [ ] Handle "Start økt" → Navigate to SessionActive (or placeholder)
  - [ ] Handle "Senere" → Navigate back to ProgramDetail
  - [ ] Add try/catch error handling
  - [ ] Show error Snackbar on failure

### Type Checking
- [ ] Run `npm run type-check` - ensure no new errors
- [ ] Verify navigation params match RootStackParamList

## Dev Notes

### Database Table (Already Exists)
```sql
CREATE TABLE planned_sessions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL DEFAULT 1,
  program_session_id INTEGER,
  planned_date TEXT NOT NULL,
  fuel_plan_json TEXT NOT NULL,
  notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (program_session_id) REFERENCES program_sessions(id)
);
```

### fuel_plan_json Format
```json
[
  {
    "fuel_product_id": 1,
    "product_name": "Maurten Gel 100",
    "quantity": 2,
    "carbs_per_serving": 25,
    "timing_minutes": [25, 50],
    "carbs_total": 50
  }
]
```

### Repository Interface
```typescript
export interface PlannedSession {
  id: number;
  user_id: number;
  program_session_id?: number;
  planned_date: string;
  fuel_plan_json: string;
  notes?: string;
  created_at: string;
}

export class PlannedSessionRepository {
  static async create(data: {
    user_id: number;
    program_session_id?: number;
    planned_date: string;
    fuel_plan_json: string;
    notes?: string;
  }): Promise<number> {
    const db = await getDatabase();
    const result = await db.runAsync(
      'INSERT INTO planned_sessions (user_id, program_session_id, planned_date, fuel_plan_json, notes) VALUES (?, ?, ?, ?, ?)',
      [data.user_id, data.program_session_id || null, data.planned_date, data.fuel_plan_json, data.notes || null]
    );
    return result.lastInsertRowId;
  }

  static async getById(id: number): Promise<PlannedSession | null> {
    const db = await getDatabase();
    const result = await db.getFirstAsync<PlannedSession>(
      'SELECT * FROM planned_sessions WHERE id = ?',
      [id]
    );
    return result || null;
  }
}
```

### Navigation Flow
```
FuelSelectorScreen
  ↓ handleConfirmPlan()
  ↓ Save to DB
  ↓ Show Snackbar
  ↓ Show Alert dialog
  ├─ "Start økt" → navigation.navigate('SessionActive', { sessionId })
  └─ "Senere" → navigation.goBack() → ProgramDetailScreen
```

### Epic 5 Placeholder Handling
If Epic 5 (SessionActive screen) not yet implemented:
```typescript
const handleStartSession = () => {
  // Check if Epic 5 screen exists
  try {
    navigation.navigate('SessionActive', { sessionId: plannedSessionId });
  } catch (error) {
    // Fallback if route doesn't exist
    Snackbar.show({
      text: 'Økt-modus kommer i Epic 5',
      duration: Snackbar.LENGTH_SHORT,
    });
    navigation.goBack();
  }
};
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story | Bob (SM) |
| 2025-10-27 | 1.1 | Refined with detailed ACs, MVP scope clarification, navigation flow, Epic 5 placeholder handling | Bob (SM) |

## Dev Agent Record
*To be filled by James (Dev)*

## QA Results
*To be filled by Quinn (QA)*
