# Story 5.4: Logg ubehag

## Status
**Ready for Development** (v2.0 - Refined by Bob SM, 2025-10-27)

## Story
**As a** user in an active session (Story 5.1),
**I want** to log GI discomfort with a quick 1-5 severity scale,
**so that** I can track symptoms during my workout and analyze patterns later.

## Acceptance Criteria

### AC1: Display Discomfort Button
**Given** user is in an active session
**When** ActiveSessionScreen is displayed
**Then** show "LOGG UBEHAG" button:
- Below "INNTAK" button
- Orange/red color scheme (warning)
- Icon: alert-circle
- Always enabled during active session

### AC2: Show Discomfort Logging Modal
**Given** user taps "LOGG UBEHAG" button
**When** modal opens
**Then** display:
- Title: "Logg ubehag"
- Severity scale: 5 large buttons (1-5) in row
  - 1: "Veldig lett" (light orange)
  - 2: "Lett" (orange)
  - 3: "Moderat" (deep orange)
  - 4: "Kraftig" (red-orange)
  - 5: "Veldig kraftig" (red)
- Symptom type dropdown (optional): "Velg type (valgfritt)"
  - Options: Kvalme, Kramper, Oppblåsthet, Diaré, Annet
- Notes field (optional): Multiline TextInput "Notater (valgfritt)"
- Cancel button

### AC3: Log Discomfort Event (Quick Log)
**Given** user has selected severity level (1-5)
**When** user taps severity button
**Then**:
- Create session_event in database:
  - `event_type`: 'discomfort'
  - `timestamp_offset_seconds`: elapsed seconds from session start
  - `actual_timestamp`: current datetime (ISO 8601)
  - `data_json`: `{ severity, symptoms?, notes? }`
- Close modal
- Show Snackbar toast: "✓ Ubehag logget (nivå 3)"
- Auto-dismiss toast after 2 seconds
- Update SessionEventList to show new event

**Edge case:** If user selects severity then changes symptom/notes, log includes all data when severity is tapped again.

### AC4: Display Discomfort in Event Log
**Given** user has logged discomfort events
**Then** SessionEventList shows discomfort events:
- Format: "HH:MM - ⚠️ Ubehag (3/5)" or "HH:MM - ⚠️ Ubehag (3/5) - Kvalme"
- Icon: Orange warning triangle (⚠️)
- Most recent at top
- Mixed with intake events in chronological order

### AC5: Calculate Timestamp Offset
**Given** session started at time T0
**When** user logs discomfort at time T1
**Then** `timestamp_offset_seconds = (T1 - T0) in seconds`

**Example:** Session started 10:00:00, discomfort logged 10:25:30 → offset = 1530 seconds

## Out of Scope (Future Stories)
- ❌ Edit/delete logged events (future enhancement)
- ❌ Discomfort analytics/patterns (Epic 7)
- ❌ Correlation with intake events (Epic 7)
- ❌ Multiple symptoms per event (MVP: single symptom type only)
- ❌ Photos of symptoms (future epic)
- ❌ Automatic symptom suggestions based on past events

## Tasks / Subtasks

### Components
- [ ] Create `src/components/session/DiscomfortModal.tsx`
  - Severity scale (1-5 buttons)
  - Symptom type dropdown (Paper Menu or custom)
  - Notes TextInput (multiline)
  - Cancel button
- [ ] Update `src/components/session/SessionEventList.tsx`
  - Add discomfort event rendering (⚠️ icon, orange color)
  - Format: "HH:MM - ⚠️ Ubehag (X/5) - [Symptom]"

### ActiveSessionScreen Updates
- [ ] Add state: `discomfortModalVisible`, `selectedSeverity`, `selectedSymptom`, `discomfortNotes`
- [ ] Add "LOGG UBEHAG" button (orange/red)
- [ ] Implement `handleLogDiscomfort(severity, symptom?, notes?)`
  - Call SessionEventRepository.createDiscomfortEvent()
  - Reload events
  - Show success Snackbar
- [ ] Update event reloading to fetch all event types (not just 'intake')

### Backend (Already Exists)
- [ ] Verify SessionEventRepository.createDiscomfortEvent() works
- [ ] Verify DiscomfortEventData interface matches requirements

### Testing
- [ ] Test discomfort logging (severity 1-5)
- [ ] Test with symptom type selected
- [ ] Test with notes entered
- [ ] Test mixed intake + discomfort events in list
- [ ] Test timestamp offset calculation accuracy
- [ ] Check database: session_events populated correctly
- [ ] Run `npm run type-check` - ensure no errors

## Dev Notes

### DiscomfortEventData Interface (Already Exists)
From `src/database/repositories/SessionEventRepository.ts`:
```typescript
export interface DiscomfortEventData {
  severity: number; // 1-5 scale
  symptoms: string[];
  notes?: string;
}
```

**Note:** MVP uses single symptom (string), not array. We'll adapt:
```typescript
export interface DiscomfortEventData {
  severity: number; // 1-5 scale
  symptom?: string; // MVP: single symptom, optional
  notes?: string;
}
```

### DiscomfortModal Component
```typescript
// src/components/session/DiscomfortModal.tsx
import React, { useState } from 'react';
import { View, StyleSheet } from 'react-native';
import { Portal, Modal, Text, Button, TextInput, Menu } from 'react-native-paper';

interface DiscomfortModalProps {
  visible: boolean;
  onDismiss: () => void;
  onSubmit: (severity: number, symptom?: string, notes?: string) => void;
}

const SEVERITY_LABELS = [
  { level: 1, label: 'Veldig lett', color: '#FFB74D' },
  { level: 2, label: 'Lett', color: '#FF9800' },
  { level: 3, label: 'Moderat', color: '#FF6F00' },
  { level: 4, label: 'Kraftig', color: '#E65100' },
  { level: 5, label: 'Veldig kraftig', color: '#BF360C' },
];

const SYMPTOM_TYPES = [
  'Kvalme',
  'Kramper',
  'Oppblåsthet',
  'Diaré',
  'Annet',
];

export const DiscomfortModal: React.FC<DiscomfortModalProps> = ({
  visible,
  onDismiss,
  onSubmit,
}) => {
  const [selectedSeverity, setSelectedSeverity] = useState<number | null>(null);
  const [symptom, setSymptom] = useState<string>('');
  const [notes, setNotes] = useState<string>('');
  const [menuVisible, setMenuVisible] = useState(false);

  const handleSubmit = () => {
    if (selectedSeverity) {
      onSubmit(
        selectedSeverity,
        symptom || undefined,
        notes || undefined
      );
      // Reset form
      setSelectedSeverity(null);
      setSymptom('');
      setNotes('');
    }
  };

  return (
    <Portal>
      <Modal
        visible={visible}
        onDismiss={onDismiss}
        contentContainerStyle={styles.modal}
      >
        <Text variant="titleLarge" style={styles.title}>
          Logg ubehag
        </Text>

        {/* Severity Scale */}
        <Text variant="bodyMedium" style={styles.sectionLabel}>
          Alvorlighetsgrad
        </Text>
        <View style={styles.severityRow}>
          {SEVERITY_LABELS.map(({ level, label, color }) => (
            <Button
              key={level}
              mode={selectedSeverity === level ? 'contained' : 'outlined'}
              onPress={() => setSelectedSeverity(level)}
              style={[styles.severityButton, selectedSeverity === level && { backgroundColor: color }]}
              labelStyle={styles.severityLabel}
            >
              {level}
            </Button>
          ))}
        </View>

        {/* Symptom Type Dropdown */}
        <Menu
          visible={menuVisible}
          onDismiss={() => setMenuVisible(false)}
          anchor={
            <Button
              mode="outlined"
              onPress={() => setMenuVisible(true)}
              style={styles.symptomButton}
            >
              {symptom || 'Velg type (valgfritt)'}
            </Button>
          }
        >
          {SYMPTOM_TYPES.map((type) => (
            <Menu.Item
              key={type}
              onPress={() => {
                setSymptom(type);
                setMenuVisible(false);
              }}
              title={type}
            />
          ))}
        </Menu>

        {/* Notes */}
        <TextInput
          label="Notater (valgfritt)"
          value={notes}
          onChangeText={setNotes}
          multiline
          numberOfLines={3}
          style={styles.notesInput}
        />

        {/* Actions */}
        <View style={styles.actions}>
          <Button mode="outlined" onPress={onDismiss}>
            Avbryt
          </Button>
          <Button
            mode="contained"
            onPress={handleSubmit}
            disabled={!selectedSeverity}
          >
            Logg ubehag
          </Button>
        </View>
      </Modal>
    </Portal>
  );
};
```

### data_json Examples
**Minimal (severity only):**
```json
{
  "severity": 3
}
```

**With symptom:**
```json
{
  "severity": 4,
  "symptom": "Kvalme"
}
```

**Full (severity + symptom + notes):**
```json
{
  "severity": 5,
  "symptom": "Kramper",
  "notes": "Oppstod 10 min etter gel"
}
```

### ActiveSessionScreen Integration
```typescript
// Add state
const [discomfortModalVisible, setDiscomfortModalVisible] = useState(false);

// Add handler
const handleLogDiscomfort = async (
  severity: number,
  symptom?: string,
  notes?: string
) => {
  if (!sessionLogId) return;

  try {
    const discomfortData: DiscomfortEventData = {
      severity,
      symptom,
      notes,
    };

    await SessionEventRepository.createDiscomfortEvent(
      sessionLogId,
      elapsedSeconds,
      discomfortData
    );

    // Reload all events (not just intake)
    await reloadEvents();

    // Show success snackbar
    setSnackbarMessage(`✓ Ubehag logget (nivå ${severity})`);
    setSnackbarVisible(true);

    // Close modal
    setDiscomfortModalVisible(false);
  } catch (err) {
    console.error('Failed to log discomfort:', err);
    setSnackbarMessage('Kunne ikke logge ubehag');
    setSnackbarVisible(true);
  }
};

// Update reloadEvents to fetch all event types
const reloadEvents = async () => {
  if (!sessionLogId) return;

  try {
    // Fetch ALL events, not just 'intake'
    const events = await SessionEventRepository.getEventsBySession(sessionLogId);
    setIntakeEvents(events); // Rename this state to just 'events'
  } catch (err) {
    console.error('Failed to reload events:', err);
  }
};

// In render:
<Button
  mode="outlined"
  icon="alert"
  onPress={() => setDiscomfortModalVisible(true)}
  style={styles.actionButton}
>
  Logg ubehag
</Button>

<DiscomfortModal
  visible={discomfortModalVisible}
  onDismiss={() => setDiscomfortModalVisible(false)}
  onSubmit={handleLogDiscomfort}
/>
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story draft | Bob (SM) |
| 2025-10-27 | 2.0 | Refined with detailed ACs (AC1-5), MVP scope, DiscomfortModal component spec, out of scope clarification, tasks breakdown, dev notes with examples | Bob (SM) |

## Dev Agent Record
*To be filled by James*

## QA Results
*To be filled by Quinn*
