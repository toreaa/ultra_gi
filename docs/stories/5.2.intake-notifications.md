# Story 5.2: Varsler for inntak

## Status
**Refinement**

## Story
**As a** user in session mode, **I want** to get notifications when it's time for planned intake, **so that** I don't forget to fuel at the right time.

## Acceptance Criteria
1. Notifikasjoner scheduleres basert på fuel plan (Epic 4)
2. Eksempel (fuel plan: 0:25, 0:50, 1:00): Etter 25 min → "⏰ Tid for inntak: Maurten Gel"
3. Notifikasjon inneholder: Tittel "Tid for inntak", Melding "[Produktnavn] ([Xg] karbs)", Lyd + Vibrasjon
4. Trykk på notifikasjon → Åpne app (aktiv økt-skjerm)
5. Notifikasjoner fortsetter selv om app er i bakgrunnen
6. Hvis spontan økt (ingen plan): Ingen notifikasjoner

## Tasks / Subtasks
- [ ] Create `src/services/notificationService.ts`
- [ ] Implement `scheduleIntakeReminder(timingMinutes, productName, carbs)`
- [ ] Use expo-notifications API
- [ ] Request NOTIFICATIONS permission on first session start
- [ ] Schedule notifications based on fuel_plan_json from planned_session
- [ ] Cancel all notifications when session ends
- [ ] Handle notification tap → deep link to ActiveSessionScreen
- [ ] Test notifications work when app backgrounded

## Dev Notes
**Implementation [Source: architecture/tech-stack.md#real-time-features]:**
```typescript
// src/services/notificationService.ts
import * as Notifications from 'expo-notifications';

export async function scheduleIntakeReminder(
  timingMinutes: number,
  productName: string,
  carbs: number
): Promise<string> {
  const trigger = { seconds: timingMinutes * 60 };

  const notificationId = await Notifications.scheduleNotificationAsync({
    content: {
      title: '⏰ Tid for inntak',
      body: `${productName} (${carbs}g karbs)`,
      sound: true,
      vibrate: [0, 250, 250, 250],
    },
    trigger,
  });

  return notificationId;
}

export async function cancelAllReminders(): Promise<void> {
  await Notifications.cancelAllScheduledNotificationsAsync();
}
```

**Permission Request:**
```typescript
const { status } = await Notifications.requestPermissionsAsync();
if (status !== 'granted') {
  Alert.alert('Notifications disabled', 'Enable to get intake reminders');
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story | Bob (SM) |

## Refinement Details

### Implementation Plan

**1. Notification Service (notificationService.ts - NEW FILE)**
Create `src/services/notificationService.ts` with:
- `requestNotificationPermissions()`: Ask for permissions on first use
- `scheduleIntakeReminder(timingMinutes, productName, carbs, sessionStartTime)`: Schedule single notification
- `scheduleAllIntakeReminders(fuelPlan, sessionStartTime)`: Schedule all reminders from fuel plan
- `cancelAllReminders()`: Cancel all scheduled notifications
- Configure notification handler for foreground behavior

**2. Permission Request (ActiveSessionScreen.tsx)**
When starting a planned session:
- Check if permissions already granted
- If not: Request permissions with `Notifications.requestPermissionsAsync()`
- Show alert if denied (optional, for UX)
- Only schedule notifications if permission granted

**3. Schedule Notifications on Session Start**
In `handleStartSession()` (ActiveSessionScreen.tsx):
- After creating session log
- If planned session with fuel plan:
  - Request notification permissions
  - Call `scheduleAllIntakeReminders(fuelPlan, sessionStartTime)`
  - Store notification IDs for cleanup (optional)

**4. Cancel Notifications on Session End**
Already implemented in sessionManager.ts:
- `cancelSessionNotifications()` calls `Notifications.cancelAllScheduledNotificationsAsync()`
- Called in `endSession()` function

**5. Notification Content (AC2-3)**
- Title: "⏰ Tid for inntak"
- Body: "[ProductName] ([X]g karbs)"
- Sound: true
- Vibrate: [0, 250, 250, 250]

**6. Deep Linking (AC4)**
- Expo notifications automatically return to app on tap
- No special deep link needed (already in ActiveSession screen)

**7. Background Support (AC5)**
- expo-notifications handles background/foreground automatically
- Notifications work when app is backgrounded

**8. Spontaneous Sessions (AC6)**
- No fuel plan → No notifications scheduled
- Simple check: `if (fuelPlan.length === 0) return;`

### Testing Checklist
- [ ] Permission request shows on first planned session
- [ ] Notifications schedule correctly based on fuel plan timings
- [ ] Notification appears at correct time with correct content
- [ ] Tap notification opens app to ActiveSession
- [ ] Notifications work when app backgrounded
- [ ] Spontaneous sessions have no notifications
- [ ] Notifications cancelled when session ends
- [ ] Multiple notifications schedule correctly (0:25, 0:50, 1:00)

## Dev Agent Record
**Agent:** Dev
**Date:** 2025-10-27
**Action:** Story refinement - detailed implementation plan

## QA Results
*To be filled*
