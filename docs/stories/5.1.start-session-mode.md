# Story 5.1: Start √∏kt-modus

## Status
**Ready for Development** (v2.0 - Refined by Bob SM, 2025-10-27)

## Story
**As a** user completing fuel plan confirmation (Story 4.3) OR starting a spontaneous session,
**I want** to start an active session with a running timer,
**so that** I can track my workout, log intake/discomfort, and recover from app crashes.

## Acceptance Criteria

### AC1: Navigation to ActiveSession Screen
**Given** user has confirmed a fuel plan in FuelSelectorScreen (Story 4.3)
**When** user taps "Start √∏kt" in the Alert dialog
**Then** navigate to `ActiveSessionScreen` with param: `plannedSessionId`

**OR**

**Given** user is on Dashboard (future: Epic 6)
**When** user taps "Start spontan √∏kt" button
**Then** navigate to `ActiveSessionScreen` with `plannedSessionId = undefined`

### AC2: Create Session Log on Start
**Given** user lands on ActiveSessionScreen
**When** user taps "START √òIKT" button
**Then** create session_log in database:
- `user_id`: 1 (hardcoded for MVP)
- `planned_session_id`: plannedSessionId from params (or null if spontaneous)
- `started_at`: current datetime (ISO 8601 UTC)
- `session_status`: 'active'
- `ended_at`: null
- `duration_actual_minutes`: null (updated during session)
**And** return `sessionLogId` for use in timer

### AC3: Start Foreground Timer
**Given** session log created successfully
**When** timer starts
**Then**:
- Display timer in HH:MM:SS format (00:00:00 at start)
- Update timer every 1 second on screen
- Create persistent foreground notification (cannot be dismissed)
- Notification shows: "üèÉ √òkt-modus aktiv" + timer (updated every 10 seconds)
- Timer runs in background (expo-task-manager + foreground service)

**Accuracy:** ¬±1 second over 4-hour period

### AC4: Auto-Save Session State (Crash Recovery)
**Given** timer is running
**When** 10 seconds elapse (Winston's POC uses 10s, not 30s)
**Then**:
- Update `session_logs.duration_actual_minutes` with elapsed time
- Store active session metadata in `app_metadata` table: `active_session_id = sessionLogId`
- Auto-save repeats every 10 seconds until session ends

**Edge case:** If app crashes, metadata allows recovery on restart (Story 5.6 - deferred)

### AC5: Timer UI Display
**Given** timer is running
**Then** screen shows:
- **Large timer display**: "01:23:45" (center, 48sp font)
- **Session info card**: Planned session details (if planned) OR "Spontan √∏kt" (if unplanned)
- **Status indicator**: "üü¢ Aktiv" badge
- **Action buttons** (deferred to Story 5.3-5.5):
  - "Logg inntak" ‚Üí Story 5.3
  - "Logg ubehag" ‚Üí Story 5.4
  - "Avslutt √∏kt" ‚Üí Story 5.5

**MVP Scope for AC5:** Only timer display + session info. Action buttons can be disabled/placeholder.

## Out of Scope (Future Stories)
- ‚ùå Crash recovery dialog (Story 5.6 - Epic 5 stretch goal)
- ‚ùå "Pause session" functionality (future enhancement)
- ‚ùå Intake/discomfort logging (Story 5.3, 5.4)
- ‚ùå End session (Story 5.5)
- ‚ùå Scheduled notifications for fuel intake (Story 5.2)
- ‚ùå Dashboard "Start spontan √∏kt" button (Epic 6)
- ‚ùå iOS support (defer to v1.1 - Android MVP first)

## Tasks / Subtasks

### Backend
- [ ] Create `src/database/repositories/SessionLogRepository.ts`
- [ ] Implement `create(data)` - INSERT into session_logs, return sessionLogId
- [ ] Implement `getById(id)` - retrieve session log
- [ ] Implement `updateDuration(id, minutes)` - auto-save duration
- [ ] Add TypeScript types: `SessionLog`, `CreateSessionLogData`
- [ ] Export from `src/database/repositories/index.ts`

### Timer Service (Winston's Hybrid Approach)
- [ ] Create `src/services/SessionTimer.ts` (based on Winston's POC)
- [ ] Implement `start(sessionLogId)` - start foreground timer
- [ ] Create foreground notification ("üèÉ √òkt-modus aktiv")
- [ ] Update timer display every 1 second (React state)
- [ ] Update notification every 10 seconds (battery optimization)
- [ ] Auto-save to database every 10 seconds
- [ ] Store `active_session_id` in app_metadata (crash recovery)
- [ ] Implement `stop()` - clear notification, stop interval

### ActiveSessionScreen UI
- [ ] Create `src/screens/session/ActiveSessionScreen.tsx`
- [ ] Accept route param: `plannedSessionId?: number`
- [ ] Show "START √òIKT" button (before timer starts)
- [ ] On tap: call SessionLogRepository.create(), start timer
- [ ] Display timer component (large HH:MM:SS)
- [ ] Show session info card (planned vs spontaneous)
- [ ] Show "üü¢ Aktiv" status badge
- [ ] Add placeholder buttons: "Logg inntak", "Logg ubehag", "Avslutt √∏kt" (disabled)

### Navigation
- [ ] Add `ActiveSession` route to `RootStackParamList` (src/types/navigation.ts)
- [ ] Update FuelSelectorScreen.tsx: Remove @ts-ignore, use typed navigation

### Testing
- [ ] Test navigation from FuelSelector ‚Üí ActiveSession
- [ ] Test session log creation (check database)
- [ ] Test timer accuracy over 30 minutes
- [ ] Test foreground notification (dismiss-proof)
- [ ] Test auto-save (check session_logs updated every 10s)
- [ ] Test spontaneous session (plannedSessionId = undefined)
- [ ] Run `npm run type-check` - ensure no TypeScript errors

## Dev Notes

### CRITICAL: Winston's POC Completed ‚úÖ

**POC Status:** Winston completed 4-hour background timer testing on 2025-10-24.
**Result:** ‚úÖ SUCCESS - Hybrid Approach recommended (see `docs/architecture/EPIC5_BACKGROUND_TIMER_POC.md`)

**Key Findings:**
- ‚úÖ 4-hour timer works with foreground service
- ‚úÖ Battery drain: ~6% per hour (acceptable)
- ‚úÖ Crash recovery: Auto-save every 10s to SQLite
- ‚ö†Ô∏è Manufacturer kills: May occur on Samsung/Xiaomi (needs testing)
- ‚úÖ Notification updates: Every 10s (not 1s) for battery optimization

**Implementation Approach:**
Use Winston's SessionTimer class from POC (see `EPIC5_BACKGROUND_TIMER_POC.md` lines 156-261).

**Key points:**
1. **Foreground notification** keeps app alive (cannot be dismissed)
2. **Update UI every 1 second** (React state for smooth timer)
3. **Update notification every 10 seconds** (battery optimization)
4. **Auto-save to SQLite every 10 seconds** (crash recovery)
5. **Store active_session_id in app_metadata** (allows recovery on restart)

**Simplified Implementation (MVP for Story 5.1):**
```typescript
// src/services/SessionTimer.ts
import * as Notifications from 'expo-notifications';
import { SessionLogRepository } from '../database/repositories/SessionLogRepository';

export class SessionTimer {
  private intervalId: NodeJS.Timeout | null = null;
  private sessionLogId: number;
  private startTime: Date;

  async start(sessionLogId: number) {
    this.sessionLogId = sessionLogId;
    this.startTime = new Date();

    // Create foreground notification
    await Notifications.scheduleNotificationAsync({
      content: {
        title: 'üèÉ √òkt-modus aktiv',
        body: '00:00:00',
        sticky: true,
        priority: Notifications.AndroidNotificationPriority.HIGH,
      },
      trigger: null,
    });

    // Update every 10 seconds (not 1s) for battery + auto-save
    this.intervalId = setInterval(async () => {
      const elapsed = this.getElapsedSeconds();
      await this.updateNotification(elapsed);
      await this.autoSave(elapsed);
    }, 10000);

    return this.intervalId;
  }

  private getElapsedSeconds(): number {
    return Math.floor((Date.now() - this.startTime.getTime()) / 1000);
  }

  private async updateNotification(elapsedSeconds: number) {
    const hours = Math.floor(elapsedSeconds / 3600);
    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
    const seconds = elapsedSeconds % 60;
    const timerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    await Notifications.scheduleNotificationAsync({
      identifier: 'active-session-timer',
      content: {
        title: 'üèÉ √òkt-modus aktiv',
        body: timerText,
      },
      trigger: null,
    });
  }

  private async autoSave(elapsedSeconds: number) {
    await SessionLogRepository.updateDuration(
      this.sessionLogId,
      Math.floor(elapsedSeconds / 60)
    );
    // Store active session ID for crash recovery (Story 5.6)
    // await storeMetadata('active_session_id', this.sessionLogId);
  }

  async stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    await Notifications.dismissAllNotificationsAsync();
  }
}
```

### SessionLogRepository Interface
```typescript
// src/database/repositories/SessionLogRepository.ts
import { getDatabase } from '../index';

export interface SessionLog {
  id: number;
  user_id: number;
  planned_session_id?: number;
  started_at: string;
  ended_at?: string;
  duration_actual_minutes?: number;
  session_status: 'active' | 'completed' | 'abandoned';
  post_session_notes?: string;
  created_at: string;
}

export interface CreateSessionLogData {
  user_id: number;
  planned_session_id?: number;
  started_at: string;
  session_status: 'active' | 'completed' | 'abandoned';
}

export class SessionLogRepository {
  static async create(data: CreateSessionLogData): Promise<number> {
    const db = await getDatabase();
    const result = await db.runAsync(
      `INSERT INTO session_logs
       (user_id, planned_session_id, started_at, session_status)
       VALUES (?, ?, ?, ?)`,
      [
        data.user_id,
        data.planned_session_id || null,
        data.started_at,
        data.session_status
      ]
    );
    return result.lastInsertRowId;
  }

  static async getById(id: number): Promise<SessionLog | null> {
    const db = await getDatabase();
    const result = await db.getFirstAsync<SessionLog>(
      'SELECT * FROM session_logs WHERE id = ?',
      [id]
    );
    return result || null;
  }

  static async updateDuration(id: number, minutes: number): Promise<void> {
    const db = await getDatabase();
    await db.runAsync(
      'UPDATE session_logs SET duration_actual_minutes = ? WHERE id = ?',
      [minutes, id]
    );
  }
}
```

### Database Schema (Already Exists)
See Migration 1 - table `session_logs` already created.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story draft | Bob (SM) |
| 2025-10-27 | 2.0 | Refined with detailed ACs (AC1-5), MVP scope, Winston's POC integration, repository pattern, out of scope clarification, SessionTimer implementation example | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
