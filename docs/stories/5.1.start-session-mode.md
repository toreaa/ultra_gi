# Story 5.1: Start økt-modus

## Status
**Draft**

## Story
**As a** user, **I want** to start session mode on my phone with a timer, **so that** I can begin tracking my session.

## Acceptance Criteria
1. "Økt-modus"-skjerm tilgjengelig fra: Dashboard "Start økt", Planlegging "Start nå", Meny "Start spontan økt"
2. Startskjerm viser: Stor "START"-knapp, Økt-info (hvis planlagt), Hvis spontan: "Uplanlagt økt"
3. Trykk "START": Timer starter (00:00:00), Session log opprettes (status='active'), Skjerm endres til aktiv økt-view, Notifikasjoner scheduleres, **Auto-save starter** (hver 30s)
4. Timer vises stort og tydelig: Format HH:MM:SS, Oppdateres hvert sekund, Nøyaktighet ±1s

## Tasks / Subtasks
- [ ] Create `src/screens/session/ActiveSessionScreen.tsx`
- [ ] Create `src/components/session/SessionTimer.tsx`
- [ ] Create `src/services/sessionManager.ts`
- [ ] Implement `startSession(plannedSessionId?): Promise<SessionLog>`
- [ ] INSERT INTO session_logs (started_at, status='active')
- [ ] Start background timer (expo-task-manager)
- [ ] Schedule notifications (Story 5.2)
- [ ] **Start auto-save** (Winston's crash recovery - every 30s)
- [ ] Display timer UI (HH:MM:SS format)
- [ ] Test timer accuracy over 30+ minutes

## Dev Notes

### CRITICAL: Background Timer & Crash Recovery

**⚠️ POC REQUIRED:** 4-hour background timer test MUST succeed before full implementation [Source: architecture/prd/epic-5-session-mode.md#critical-testing]

**Timer Implementation [Source: architecture/tech-stack.md#real-time-features]:**
```typescript
// src/services/sessionManager.ts
import * as TaskManager from 'expo-task-manager';
import * as BackgroundFetch from 'expo-background-fetch';
import { autoSaveSessionState } from './sessionRecovery';

const SESSION_TIMER_TASK = 'session-timer-task';

TaskManager.defineTask(SESSION_TIMER_TASK, async () => {
  const activeSessionId = await getActiveSessionId();
  const elapsedSeconds = calculateElapsed();
  
  // Winston's auto-save (every 30s)
  await autoSaveSessionState(activeSessionId, elapsedSeconds);
  
  return BackgroundFetch.BackgroundFetchResult.NewData;
});

export async function startSession(plannedSessionId?: number): Promise<SessionLog> {
  const db = await getDatabase();
  const result = await db.runAsync(
    'INSERT INTO session_logs (user_id, planned_session_id, started_at, session_status) VALUES (?, ?, datetime("now"), ?)',
    [1, plannedSessionId || null, 'active']
  );

  await BackgroundFetch.registerTaskAsync(SESSION_TIMER_TASK, {
    minimumInterval: 30, // 30 seconds
    stopOnTerminate: false,
    startOnBoot: false,
  });

  return { id: result.lastInsertRowId, started_at: new Date().toISOString(), status: 'active' };
}
```

**Crash Recovery Integration [Source: Winston's sessionRecovery.ts]:**
```typescript
// On app startup (App.tsx)
import { useSessionRecovery } from '@hooks/useSessionRecovery';

function App() {
  const recovery = useSessionRecovery();

  if (recovery.recoverableSession) {
    return (
      <RecoveryDialog
        message={recovery.recoveryMessage}
        eventCount={recovery.recoverableSession.eventCount}
        onRecover={async () => {
          const data = await recovery.attemptRecovery();
          // Navigate to ActiveSessionScreen with recovered data
        }}
        onDiscard={() => recovery.discardSession()}
        onDismiss={() => recovery.dismissRecovery()}
      />
    );
  }

  return <MainApp />;
}
```

**Auto-Save [Source: Winston's implementation]:**
```typescript
// Called every 30s during active session
export async function autoSaveSessionState(sessionId: number, elapsedSeconds: number): Promise<void> {
  const db = await getDatabase();
  await db.runAsync(
    'UPDATE session_logs SET duration_actual_minutes = ? WHERE id = ?',
    [Math.floor(elapsedSeconds / 60), sessionId]
  );
  
  // Store metadata for crash recovery
  await storeActiveSessionMetadata(sessionId, elapsedSeconds);
}
```

**Database:**
```sql
CREATE TABLE session_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL DEFAULT 1,
  planned_session_id INTEGER,
  started_at TEXT NOT NULL,
  ended_at TEXT,
  duration_actual_minutes INTEGER,
  session_status TEXT NOT NULL DEFAULT 'active',
  post_session_notes TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (planned_session_id) REFERENCES planned_sessions(id)
);
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story with crash recovery | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
