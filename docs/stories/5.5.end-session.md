# Story 5.5: Avslutt økt

## Status
**Draft**

## Story
**As a** user, **I want** to end my session in the app, **so that** the log is saved.

## Acceptance Criteria
1. "Avslutt økt"-knapp tilgjengelig på aktiv økt-skjerm (øverst, meny/ikon)
2. Trykk "Avslutt" → Bekreftelsesdialog: "Avslutt økt?" med timer og event count
3. Ved bekreftelse: Timer stopper, Session log oppdateres (ended_at, duration_actual_minutes, session_status='completed'), Notifikasjoner kanselleres, **Auto-save stoppes**, **Recovery metadata ryddes** (Winston's clearActiveSessionMetadata())
4. Navigering til oppsummeringsskjerm: Vis total tid, antall inntak, antall ubehag, Knapper: "Se analyse" (Epic 7), "Legg til notater", "Tilbake til dashboard"

## Tasks / Subtasks
- [ ] Add "Avslutt økt" button to ActiveSessionScreen header
- [ ] Show confirmation dialog with session summary
- [ ] Implement `sessionManager.endSession()`
- [ ] UPDATE session_logs: SET ended_at, duration_actual_minutes, session_status='completed'
- [ ] Cancel all scheduled notifications
- [ ] Stop background timer task
- [ ] **Call clearActiveSessionMetadata()** (Winston's crash recovery cleanup)
- [ ] Create `src/screens/session/SessionSummaryScreen.tsx`
- [ ] Display session summary (duration, events, carbs consumed)
- [ ] Navigate to summary screen after ending
- [ ] Add navigation to Epic 7 analysis from summary

## Dev Notes
**Winston's Recovery Cleanup [Source: sessionRecovery.ts]:**
```typescript
export async function clearActiveSessionMetadata(): Promise<void> {
  await AsyncStorage.removeItem('active_session_id');
  await AsyncStorage.removeItem('session_start_time');
  await AsyncStorage.removeItem('last_auto_save');
}
```

**End Session Implementation:**
```typescript
// src/services/sessionManager.ts
export async function endSession(): Promise<void> {
  const activeSessionId = await getActiveSessionId();
  const startTime = await getSessionStartTime();
  const duration = Math.floor((Date.now() - startTime) / 1000 / 60); // minutes

  const db = await getDatabase();
  await db.runAsync(
    'UPDATE session_logs SET ended_at = datetime("now"), duration_actual_minutes = ?, session_status = ? WHERE id = ?',
    [duration, 'completed', activeSessionId]
  );

  // Cancel notifications
  await cancelAllReminders();

  // Stop background task
  await BackgroundFetch.unregisterTaskAsync(SESSION_TIMER_TASK);

  // Winston's cleanup
  await clearActiveSessionMetadata();
}
```

**Summary Screen:**
```typescript
<SessionSummaryScreen>
  <Text>Økt fullført!</Text>
  <Text>Total tid: {formatDuration(session.duration_actual_minutes)}</Text>
  <Text>Inntak: {intakeCount} hendelser</Text>
  <Text>Ubehag: {discomfortCount} hendelser</Text>
  <Button onPress={() => navigate('SessionAnalysis', {sessionId})}>Se analyse</Button>
  <Button onPress={() => navigate('Dashboard')}>Tilbake til dashboard</Button>
</SessionSummaryScreen>
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story with crash recovery cleanup | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
