# Story 5.5: Avslutt Ã¸kt

## Status
**Refinement**

## Story
**As a** user, **I want** to end my session in the app, **so that** the log is saved.

## Acceptance Criteria
1. "Avslutt Ã¸kt"-knapp tilgjengelig pÃ¥ aktiv Ã¸kt-skjerm (Ã¸verst, meny/ikon)
2. Trykk "Avslutt" â†’ Bekreftelsesdialog: "Avslutt Ã¸kt?" med timer og event count
3. Ved bekreftelse: Timer stopper, Session log oppdateres (ended_at, duration_actual_minutes, session_status='completed'), Notifikasjoner kanselleres, **Auto-save stoppes**, **Recovery metadata ryddes** (Winston's clearActiveSessionMetadata())
4. Navigering til oppsummeringsskjerm: Vis total tid, antall inntak, antall ubehag, Knapper: "Se analyse" (Epic 7), "Legg til notater", "Tilbake til dashboard"

## Tasks / Subtasks
- [ ] Add "Avslutt Ã¸kt" button to ActiveSessionScreen header
- [ ] Show confirmation dialog with session summary
- [ ] Implement `sessionManager.endSession()`
- [ ] UPDATE session_logs: SET ended_at, duration_actual_minutes, session_status='completed'
- [ ] Cancel all scheduled notifications
- [ ] Stop background timer task
- [ ] **Call clearActiveSessionMetadata()** (Winston's crash recovery cleanup)
- [ ] Create `src/screens/session/SessionSummaryScreen.tsx`
- [ ] Display session summary (duration, events, carbs consumed)
- [ ] Navigate to summary screen after ending
- [ ] Add navigation to Epic 7 analysis from summary

## Dev Notes
**Winston's Recovery Cleanup [Source: sessionRecovery.ts]:**
```typescript
export async function clearActiveSessionMetadata(): Promise<void> {
  await AsyncStorage.removeItem('active_session_id');
  await AsyncStorage.removeItem('session_start_time');
  await AsyncStorage.removeItem('last_auto_save');
}
```

**End Session Implementation:**
```typescript
// src/services/sessionManager.ts
export async function endSession(): Promise<void> {
  const activeSessionId = await getActiveSessionId();
  const startTime = await getSessionStartTime();
  const duration = Math.floor((Date.now() - startTime) / 1000 / 60); // minutes

  const db = await getDatabase();
  await db.runAsync(
    'UPDATE session_logs SET ended_at = datetime("now"), duration_actual_minutes = ?, session_status = ? WHERE id = ?',
    [duration, 'completed', activeSessionId]
  );

  // Cancel notifications
  await cancelAllReminders();

  // Stop background task
  await BackgroundFetch.unregisterTaskAsync(SESSION_TIMER_TASK);

  // Winston's cleanup
  await clearActiveSessionMetadata();
}
```

**Summary Screen:**
```typescript
<SessionSummaryScreen>
  <Text>Ã˜kt fullfÃ¸rt!</Text>
  <Text>Total tid: {formatDuration(session.duration_actual_minutes)}</Text>
  <Text>Inntak: {intakeCount} hendelser</Text>
  <Text>Ubehag: {discomfortCount} hendelser</Text>
  <Button onPress={() => navigate('SessionAnalysis', {sessionId})}>Se analyse</Button>
  <Button onPress={() => navigate('Dashboard')}>Tilbake til dashboard</Button>
</SessionSummaryScreen>
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story with crash recovery cleanup | Bob (SM) |

## Refinement Details

### Implementation Plan

**1. End Session Functionality (sessionManager.ts - NEW FILE)**
Create `src/services/sessionManager.ts` with:
- `endSession(sessionLogId: number, elapsedSeconds: number): Promise<void>`
  - Update session_logs: SET ended_at, duration_actual_minutes, session_status='completed'
  - Cancel all scheduled notifications (if any)
  - Call clearActiveSessionMetadata() from sessionRecovery
  - No need for background task cleanup (we use foreground timer)

**2. End Session Button (ActiveSessionScreen.tsx)**
Add IconButton in Appbar.Header:
- Icon: "stop-circle-outline"
- Position: Right side of header
- OnPress: Show confirmation dialog
- Only visible when session is started

**3. Confirmation Dialog**
Portal + Dialog with:
- Title: "Avslutt Ã¸kt?"
- Content: Display session summary
  - Timer display (HH:MM:SS)
  - Event count: "{intakeCount} inntak, {discomfortCount} ubehag"
- Actions: "Avbryt" (dismiss), "Avslutt" (confirm)
- On confirm: Call endSession() then navigate to SessionSummary

**4. Session Summary Screen (SessionSummaryScreen.tsx - NEW FILE)**
Create `src/screens/session/SessionSummaryScreen.tsx`:
- Header: "Ã˜kt fullfÃ¸rt! ðŸŽ‰"
- Display completed session data:
  - Total duration (HH:MM:SS format)
  - Intake count
  - Discomfort count
  - Total carbs consumed (sum from intake events)
- Action buttons:
  - "Se analyse" â†’ Navigate to Epic 7 (placeholder for now)
  - "Legg til notater" â†’ Show notes input (optional)
  - "Tilbake til dashboard" â†’ Navigate home
- Load session data from route params (sessionLogId)

**5. Navigation Updates**
- Add SessionSummary to RootStackParamList
- Register screen in navigation setup

### Database Changes
No schema changes required - all fields exist.

### Dependencies
- expo-notifications (already installed) - for notification cancellation
- sessionRecovery.clearActiveSessionMetadata() (already exists)
- SessionLogRepository methods (already exists)

### Testing Checklist
- [ ] End session button appears when session starts
- [ ] Confirmation dialog shows correct session summary
- [ ] Cancel keeps session running
- [ ] Confirm ends session and updates database
- [ ] SessionSummaryScreen displays correct data
- [ ] Navigation flows work correctly
- [ ] Recovery metadata is cleared
- [ ] Sessions can be ended multiple times (idempotent)

## Dev Agent Record
**Agent:** Dev
**Date:** 2025-10-27
**Action:** Story refinement - detailed implementation plan

## QA Results
*To be filled*
