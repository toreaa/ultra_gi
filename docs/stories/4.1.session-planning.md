# Story 4.1: Velg økt → ernæringsplan

## Status
**Ready for Development**

## Story
**As a** user, **when** I select today's program session, **I want** the app to create a concrete nutrition plan, **so that** I know exactly what to take and when.

## Scope
This story implements the **session planning initiation screen**. It shows session details and calculates carb requirements. Product selection (AC4) and plan confirmation are handled in Stories 4.2 and 4.3.

**Navigation Entry Points:**
- From ProgramDetailScreen → Click on session card (primary path for this story)
- From HomeScreen → "Planlegg neste økt" button (deferred - depends on session scheduling)
- From menu → "Start spontan økt" (deferred - requires spontaneous session support)

**For this story**, we'll focus on the primary path: navigating from a session card in ProgramDetailScreen.

## Acceptance Criteria
1. ✅ **TO IMPLEMENT:** Bruker kommer til planleggingsskjerm fra program-detaljer (trykk på økt)
2. ✅ **TO IMPLEMENT:** Skjerm viser økt-info: Program + Uke/Økt, Varighet, Mål-intensitet, Intensitetssone
3. ✅ **TO IMPLEMENT:** Appen beregner totalt karb-behov: Formula: `(duration_minutes / 60) * carb_rate_g_per_hour`, Vis: "Du trenger ca. 56g karbohydrater for denne økten"
4. ⏸️ **DEFERRED TO 4.2:** Appen foreslår produkter fra skafferi
5. ✅ **TO IMPLEMENT:** Knapp: "Lag plan" (placeholder - will connect to Story 4.2)

## Tasks / Subtasks
- [ ] Add `SessionPlan` screen to navigation types (`ProgramStackParamList`)
- [ ] Add `getSessionById(sessionId)` method to ProgramRepository
- [ ] Create `src/screens/session/SessionPlanScreen.tsx`
- [ ] Load program_session and program details
- [ ] Calculate required carbs: `(duration / 60) * carbRate`
- [ ] Display session info (program, week, duration, target rate)
- [ ] Add "Lag plan" button with placeholder (Snackbar: "Produktvalg kommer i Story 4.2")
- [ ] Update SessionCard in ProgramDetailScreen to navigate to SessionPlan
- [ ] Update ProgramDetailScreen placeholder from "Planlegging kommer i Epic 4" to actual navigation

## Dev Notes

### From Existing Code (Story 3.3)
- ✅ `ProgramRepository.getById(programId)` - fetches Program details
- ✅ `ProgramRepository.getProgramSessions(programId)` - fetches all sessions
- ❌ **MISSING:** `ProgramRepository.getSessionById(sessionId)` - need to add this
- ✅ ProgramDetailScreen has `handleSessionPress(sessionId)` placeholder (line 115-119)

### Navigation Types Update

**Add to `src/types/navigation.ts`:**
```typescript
export type ProgramStackParamList = {
  ProgramList: undefined;
  ProgramDetail: { programId: number; userProgramId?: number };
  SessionPlan: { sessionId: number; programId: number }; // NEW
};
```

### ProgramRepository Method

**Add to `src/database/repositories/ProgramRepository.ts`:**
```typescript
/**
 * Get a single program session by ID
 */
static async getSessionById(sessionId: number): Promise<ProgramSession | null> {
  try {
    const db = await getDatabase();
    const session = await db.getFirstAsync<ProgramSession>(
      `SELECT * FROM program_sessions WHERE id = ?`,
      [sessionId]
    );
    return session || null;
  } catch (error) {
    console.error('ProgramRepository.getSessionById failed:', error);
    throw error;
  }
}
```

### SessionPlanScreen Component

**File:** `src/screens/session/SessionPlanScreen.tsx`

**Props from navigation:**
- `sessionId: number` - Program session ID
- `programId: number` - Program ID (to fetch program details)

**State:**
- `session: ProgramSession | null`
- `program: Program | null`
- `loading: boolean`
- `error: string | null`
- `snackbarVisible: boolean`

**Calculation:**
```typescript
const totalCarbs = session
  ? Math.round((session.duration_minutes / 60) * session.carb_rate_g_per_hour)
  : 0;
```

**UI Structure:**
```typescript
<Appbar.Header>
  <Appbar.BackAction onPress={() => navigation.goBack()} />
  <Appbar.Content title="Planlegg økt" />
</Appbar.Header>

<ScrollView>
  {/* Session Info Card */}
  <Card>
    <Card.Title title="Øktinformasjon" />
    <Card.Content>
      <Text>Program: {program.name}</Text>
      <Text>Uke {session.week_number}, Økt {session.session_number}</Text>
      <Text>Varighet: {session.duration_minutes} min</Text>
      <Text>Intensitet: {session.intensity_zone}</Text>
      <Text>Mål: {session.carb_rate_g_per_hour}g/t</Text>
    </Card.Content>
  </Card>

  {/* Carb Calculation Card */}
  <Card>
    <Card.Title title="Karbohydratbehov" />
    <Card.Content>
      <Text variant="headlineMedium">{totalCarbs}g</Text>
      <Text>Du trenger ca. {totalCarbs}g karbohydrater for denne økten</Text>
      <Text variant="bodySmall">
        Beregning: ({session.duration_minutes} min / 60) × {session.carb_rate_g_per_hour}g/t
      </Text>
    </Card.Content>
  </Card>

  {/* Action Button */}
  <Button
    mode="contained"
    onPress={handleCreatePlan}
    icon="food-apple"
  >
    Lag plan
  </Button>
</ScrollView>

<Snackbar
  visible={snackbarVisible}
  onDismiss={() => setSnackbarVisible(false)}
  duration={3000}
>
  Produktvalg kommer i Story 4.2
</Snackbar>
```

### ProgramDetailScreen Update

**Replace handleSessionPress (line 115-119):**
```typescript
const handleSessionPress = (sessionId: number) => {
  navigation.navigate('SessionPlan', {
    sessionId,
    programId
  });
};
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story | Bob (SM) |
| 2025-10-26 | 1.1 | Refined scope to focus on primary navigation path (from ProgramDetailScreen). Added detailed implementation notes, navigation types, and repository method. AC4 deferred to Story 4.2. Status changed to Ready for Development. | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
