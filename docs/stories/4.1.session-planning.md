# Story 4.1: Velg økt → ernæringsplan

## Status
**Ready for Review**

## Story
**As a** user, **when** I select today's program session, **I want** the app to create a concrete nutrition plan, **so that** I know exactly what to take and when.

## Scope
This story implements the **session planning initiation screen**. It shows session details and calculates carb requirements. Product selection (AC4) and plan confirmation are handled in Stories 4.2 and 4.3.

**Navigation Entry Points:**
- From ProgramDetailScreen → Click on session card (primary path for this story)
- From HomeScreen → "Planlegg neste økt" button (deferred - depends on session scheduling)
- From menu → "Start spontan økt" (deferred - requires spontaneous session support)

**For this story**, we'll focus on the primary path: navigating from a session card in ProgramDetailScreen.

## Acceptance Criteria
1. ✅ **TO IMPLEMENT:** Bruker kommer til planleggingsskjerm fra program-detaljer (trykk på økt)
2. ✅ **TO IMPLEMENT:** Skjerm viser økt-info: Program + Uke/Økt, Varighet, Mål-intensitet, Intensitetssone
3. ✅ **TO IMPLEMENT:** Appen beregner totalt karb-behov: Formula: `(duration_minutes / 60) * carb_rate_g_per_hour`, Vis: "Du trenger ca. 56g karbohydrater for denne økten"
4. ⏸️ **DEFERRED TO 4.2:** Appen foreslår produkter fra skafferi
5. ✅ **TO IMPLEMENT:** Knapp: "Lag plan" (placeholder - will connect to Story 4.2)

## Tasks / Subtasks
- [x] Add `SessionPlan` screen to navigation types (`ProgramStackParamList`)
- [x] Add `getSessionById(sessionId)` method to ProgramRepository
- [x] Create `src/screens/session/SessionPlanScreen.tsx`
- [x] Load program_session and program details
- [x] Calculate required carbs: `(duration / 60) * carbRate`
- [x] Display session info (program, week, duration, target rate)
- [x] Add "Lag plan" button with placeholder (Snackbar: "Produktvalg kommer i Story 4.2")
- [x] Update SessionCard in ProgramDetailScreen to navigate to SessionPlan
- [x] Update ProgramDetailScreen placeholder from "Planlegging kommer i Epic 4" to actual navigation

## Dev Notes

### From Existing Code (Story 3.3)
- ✅ `ProgramRepository.getById(programId)` - fetches Program details
- ✅ `ProgramRepository.getProgramSessions(programId)` - fetches all sessions
- ❌ **MISSING:** `ProgramRepository.getSessionById(sessionId)` - need to add this
- ✅ ProgramDetailScreen has `handleSessionPress(sessionId)` placeholder (line 115-119)

### Navigation Types Update

**Add to `src/types/navigation.ts`:**
```typescript
export type ProgramStackParamList = {
  ProgramList: undefined;
  ProgramDetail: { programId: number; userProgramId?: number };
  SessionPlan: { sessionId: number; programId: number }; // NEW
};
```

### ProgramRepository Method

**Add to `src/database/repositories/ProgramRepository.ts`:**
```typescript
/**
 * Get a single program session by ID
 */
static async getSessionById(sessionId: number): Promise<ProgramSession | null> {
  try {
    const db = await getDatabase();
    const session = await db.getFirstAsync<ProgramSession>(
      `SELECT * FROM program_sessions WHERE id = ?`,
      [sessionId]
    );
    return session || null;
  } catch (error) {
    console.error('ProgramRepository.getSessionById failed:', error);
    throw error;
  }
}
```

### SessionPlanScreen Component

**File:** `src/screens/session/SessionPlanScreen.tsx`

**Props from navigation:**
- `sessionId: number` - Program session ID
- `programId: number` - Program ID (to fetch program details)

**State:**
- `session: ProgramSession | null`
- `program: Program | null`
- `loading: boolean`
- `error: string | null`
- `snackbarVisible: boolean`

**Calculation:**
```typescript
const totalCarbs = session
  ? Math.round((session.duration_minutes / 60) * session.carb_rate_g_per_hour)
  : 0;
```

**UI Structure:**
```typescript
<Appbar.Header>
  <Appbar.BackAction onPress={() => navigation.goBack()} />
  <Appbar.Content title="Planlegg økt" />
</Appbar.Header>

<ScrollView>
  {/* Session Info Card */}
  <Card>
    <Card.Title title="Øktinformasjon" />
    <Card.Content>
      <Text>Program: {program.name}</Text>
      <Text>Uke {session.week_number}, Økt {session.session_number}</Text>
      <Text>Varighet: {session.duration_minutes} min</Text>
      <Text>Intensitet: {session.intensity_zone}</Text>
      <Text>Mål: {session.carb_rate_g_per_hour}g/t</Text>
    </Card.Content>
  </Card>

  {/* Carb Calculation Card */}
  <Card>
    <Card.Title title="Karbohydratbehov" />
    <Card.Content>
      <Text variant="headlineMedium">{totalCarbs}g</Text>
      <Text>Du trenger ca. {totalCarbs}g karbohydrater for denne økten</Text>
      <Text variant="bodySmall">
        Beregning: ({session.duration_minutes} min / 60) × {session.carb_rate_g_per_hour}g/t
      </Text>
    </Card.Content>
  </Card>

  {/* Action Button */}
  <Button
    mode="contained"
    onPress={handleCreatePlan}
    icon="food-apple"
  >
    Lag plan
  </Button>
</ScrollView>

<Snackbar
  visible={snackbarVisible}
  onDismiss={() => setSnackbarVisible(false)}
  duration={3000}
>
  Produktvalg kommer i Story 4.2
</Snackbar>
```

### ProgramDetailScreen Update

**Replace handleSessionPress (line 115-119):**
```typescript
const handleSessionPress = (sessionId: number) => {
  navigation.navigate('SessionPlan', {
    sessionId,
    programId
  });
};
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story | Bob (SM) |
| 2025-10-26 | 1.1 | Refined scope to focus on primary navigation path (from ProgramDetailScreen). Added detailed implementation notes, navigation types, and repository method. AC4 deferred to Story 4.2. Status changed to Ready for Development. | Bob (SM) |
| 2025-10-26 | 1.2 | Implementation completed. All tasks completed (AC1,2,3,5). Created SessionPlanScreen with session details and carb calculation. Added getSessionById() repository method. Updated navigation. Status changed to Ready for Review. | James (Dev) |

## Dev Agent Record

**Developer:** James
**Date:** 2025-10-26
**Status:** Ready for Review

### Implementation Summary

Successfully implemented session planning initiation screen with session details display and carbohydrate requirement calculation. This creates the foundation for Epic 4's session planning workflow.

### Files Created

1. **`src/screens/session/SessionPlanScreen.tsx`** (296 lines)
   - New screen showing session details and carb calculations
   - Material Design cards for session info and carb requirements
   - Full TypeScript typing with React.FC pattern
   - Error handling with user-friendly error screen
   - Loading state with ActivityIndicator
   - Snackbar placeholder for Story 4.2 integration

### Files Modified

2. **`src/types/navigation.ts`**
   - Added `SessionPlan: { sessionId: number; programId: number }` to `ProgramStackParamList`

3. **`src/database/repositories/ProgramRepository.ts`**
   - Added `getSessionById(sessionId)` method
   - Fetches single session from `program_sessions` table
   - Returns `ProgramSession | null`
   - Parameterized query for SQL injection prevention

4. **`src/screens/programs/ProgramDetailScreen.tsx`**
   - Updated `handleSessionPress()` to navigate to SessionPlan screen
   - Removed Epic 4 placeholder Snackbar message
   - Passes `sessionId` and `programId` as navigation params

5. **`src/navigation/ProgramStackNavigator.tsx`**
   - Registered SessionPlanScreen in stack navigator
   - Added import for SessionPlanScreen component
   - Added Stack.Screen configuration with title "Planlegg økt"

### Acceptance Criteria Coverage

✅ **AC1:** Bruker kommer til planleggingsskjerm fra program-detaljer (trykk på økt) - IMPLEMENTED
✅ **AC2:** Skjerm viser økt-info (Program, Uke/Økt, Varighet, Intensitet, Mål) - IMPLEMENTED
✅ **AC3:** Appen beregner totalt karb-behov med formel - IMPLEMENTED
⏸️ **AC4:** Appen foreslår produkter fra skafferi - DEFERRED to Story 4.2
✅ **AC5:** Knapp "Lag plan" med placeholder - IMPLEMENTED

### Technical Decisions

1. **Carb Calculation Formula:**
   ```typescript
   const totalCarbs = Math.round((session.duration_minutes / 60) * session.carb_rate_g_per_hour);
   ```
   - Rounds to nearest whole number for user-friendly display
   - Example: 75 min × 45g/h = 56g

2. **Navigation Parameters:**
   - Decided to pass both `sessionId` and `programId`
   - `programId` needed for program details (name, description)
   - `sessionId` needed for session-specific data
   - Alternative considered: Fetch programId from session data (rejected - extra database query)

3. **UI Design:**
   - Two Material Design cards: Session Info + Carb Calculation
   - Info rows with icons for visual consistency
   - Highlighted carb number (displaySmall variant, green background)
   - Formula shown below calculation for transparency
   - Follows existing app patterns from Epic 3

4. **Error Handling:**
   - Separate error states for session/program not found
   - User-friendly error messages in Norwegian
   - "Gå tilbake" button for easy recovery
   - Console logging for debugging

5. **Placeholder for Story 4.2:**
   - "Lag plan" button shows Snackbar: "Produktvalg kommer i Story 4.2"
   - Navigation will be implemented in next story
   - Keeps user informed about upcoming functionality

### TypeScript Status

- No NEW TypeScript errors introduced by Story 4.1 code
- Fixed 2 errors during development (duplicate `size` prop in MaterialCommunityIcons)
- All pre-existing errors unrelated to this story
- Full type safety with navigation params, props, state

### Testing Notes

- No automated tests added (consistent with Epic 3 pattern)
- Manual testing requires:
  - Navigate to program detail screen
  - Click on any session card
  - Verify SessionPlanScreen loads with correct data
  - Verify carb calculation is correct
  - Test "Lag plan" button shows placeholder Snackbar
  - Test back navigation
  - Test error states (invalid session ID)

### Dependencies

- No new dependencies added
- Uses existing: `react-native-paper`, `@expo/vector-icons`, `@react-navigation/native`
- Reuses ProgramRepository patterns from Epic 3

## QA Results
*To be filled*
