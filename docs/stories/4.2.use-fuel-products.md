# Story 4.2: Bruk produkter fra skafferi

## Status
**Ready for Development**

## Story
**As a** user, **I want** the nutrition plan to use products from my skafferi, **so that** the plan is realistic and practical for me.

## Scope
This story builds on Story 4.1 (SessionPlanScreen). It implements the fuel planning algorithm and product selection UI. The "Lag plan" button from Story 4.1 will navigate to this new screen. Plan confirmation and saving (AC5 "Akseptere forslag") is handled in Story 4.3.

## Acceptance Criteria
1. ✅ **TO IMPLEMENT:** Appen genererer forslag basert på tilgjengelige produkter fra skafferi
2. ✅ **TO IMPLEMENT:** Algoritme (MVP - enkel greedy): Sorter produkter etter carbs descending, Velg kombinasjon som treffer ~90-110% av mål, Maks 5 enheter per produkt
3. ✅ **TO IMPLEMENT:** Foreslått plan vises som liste: Produktnavn, Antall, Total karbs, Prosent av mål
4. ✅ **TO IMPLEMENT:** Timing-forslag (auto-generert): Del opp inntak jevnt over økten
5. ⏸️ **DEFERRED TO 4.3:** Bruker kan akseptere forslag og lagre plan
6. ✅ **TO IMPLEMENT:** Manuell tilpasning: endre antall, legge til/fjerne produkter, live oppdatering av total
7. ✅ **TO IMPLEMENT:** Edge case: Tomt skafferi → vis feilmelding med "Gå til skafferi"-knapp

## Tasks / Subtasks
- [ ] Add navigation types for FuelSelector screen
- [ ] Create `src/types/fuelPlan.ts` (FuelPlanItem, FuelPlan interfaces)
- [ ] Create `src/services/fuelPlanner.ts` with algorithm
- [ ] Implement `generateFuelPlan(targetCarbs, duration, availableProducts)`
- [ ] Implement greedy algorithm (sort by carbs descending, select best fit)
- [ ] Generate timing suggestions: `Array.from({length: qty}, (_, i) => Math.round((i + 1) * interval))`
- [ ] Create `src/screens/session/FuelSelectorScreen.tsx`
- [ ] Load user's fuel products from FuelProductRepository
- [ ] Generate initial plan using fuelPlanner service
- [ ] Display plan items with product name, quantity, carbs, timing
- [ ] Show total carbs and percentage of target
- [ ] Allow manual quantity adjustments (+ / - buttons)
- [ ] Allow adding/removing products
- [ ] Real-time update total carbs and percentage
- [ ] Handle edge case: empty skafferi → EmptyState with "Gå til skafferi"
- [ ] Add "Bekreft plan" button (navigate to Story 4.3)
- [ ] Update SessionPlanScreen "Lag plan" button to navigate to FuelSelector
- [ ] Register FuelSelectorScreen in navigation

## Dev Notes

### From Story 4.1
- ✅ SessionPlanScreen displays session details and targetCarbs
- ✅ "Lag plan" button (line 207-215) shows placeholder Snackbar
- ✅ Need to replace handleCreatePlan() to navigate to FuelSelector
- ✅ Pass sessionId, programId, targetCarbs, duration as navigation params

### Navigation Types

**Add to `src/types/navigation.ts`:**
```typescript
export type ProgramStackParamList = {
  ProgramList: undefined;
  ProgramDetail: { programId: number; userProgramId?: number };
  SessionPlan: { sessionId: number; programId: number };
  FuelSelector: { sessionId: number; targetCarbs: number; durationMinutes: number }; // NEW
};
```

### Fuel Plan Types

**Create `src/types/fuelPlan.ts`:**
```typescript
export interface FuelPlanItem {
  fuel_product_id: number;
  product_name: string;
  quantity: number;
  carbs_per_serving: number;
  timing_minutes: number[];
  carbs_total: number;
}

export interface FuelPlan {
  items: FuelPlanItem[];
  total_carbs: number;
  target_carbs: number;
  percentage: number; // (total_carbs / target_carbs) * 100
}
```

### Fuel Planner Service

**Create `src/services/fuelPlanner.ts`:**

```typescript
import { FuelProduct } from '../types/database';
import { FuelPlan, FuelPlanItem } from '../types/fuelPlan';

/**
 * Generate fuel plan using greedy algorithm
 * Sorts products by carbs (descending), selects best fit
 * Target: 90-110% of carb requirement
 */
export function generateFuelPlan(
  targetCarbs: number,
  durationMinutes: number,
  availableProducts: FuelProduct[]
): FuelPlan {
  const items: FuelPlanItem[] = [];
  let remainingCarbs = targetCarbs;

  // Sort by carbs per serving (descending) - greedy approach
  const sorted = [...availableProducts].sort((a, b) =>
    b.carbs_per_serving - a.carbs_per_serving
  );

  for (const product of sorted) {
    if (remainingCarbs <= 0) break;

    // Calculate quantity needed, max 5 units per product
    const quantity = Math.min(
      Math.ceil(remainingCarbs / product.carbs_per_serving),
      5
    );

    const carbsTotal = product.carbs_per_serving * quantity;

    items.push({
      fuel_product_id: product.id,
      product_name: product.name,
      quantity,
      carbs_per_serving: product.carbs_per_serving,
      timing_minutes: generateTiming(durationMinutes, quantity),
      carbs_total: carbsTotal,
    });

    remainingCarbs -= carbsTotal;
  }

  const totalCarbs = items.reduce((sum, item) => sum + item.carbs_total, 0);

  return {
    items,
    total_carbs: totalCarbs,
    target_carbs: targetCarbs,
    percentage: Math.round((totalCarbs / targetCarbs) * 100),
  };
}

/**
 * Generate timing suggestions
 * Distributes intake evenly across session duration
 * Example: 75 min, 3 items → [19, 38, 56]
 */
function generateTiming(duration: number, quantity: number): number[] {
  if (quantity === 0) return [];
  const interval = duration / (quantity + 1);
  return Array.from({ length: quantity }, (_, i) =>
    Math.round((i + 1) * interval)
  );
}

/**
 * Recalculate plan totals after manual adjustments
 */
export function recalculatePlan(
  items: FuelPlanItem[],
  targetCarbs: number
): FuelPlan {
  const totalCarbs = items.reduce((sum, item) => sum + item.carbs_total, 0);
  return {
    items,
    total_carbs: totalCarbs,
    target_carbs: targetCarbs,
    percentage: Math.round((totalCarbs / targetCarbs) * 100),
  };
}
```

### FuelSelectorScreen Component

**File:** `src/screens/session/FuelSelectorScreen.tsx`

**State:**
- `plan: FuelPlan` - Current fuel plan with items and totals
- `availableProducts: FuelProduct[]` - All user's products from skafferi
- `loading: boolean`
- `error: string | null`

**Key Functions:**
```typescript
// Adjust quantity for a plan item
const handleQuantityChange = (productId: number, delta: number) => {
  const updated = plan.items.map(item => {
    if (item.fuel_product_id === productId) {
      const newQuantity = Math.max(0, Math.min(5, item.quantity + delta));
      const newCarbs = newQuantity * item.carbs_per_serving;
      const newTiming = newQuantity > 0
        ? generateTiming(durationMinutes, newQuantity)
        : [];

      return {
        ...item,
        quantity: newQuantity,
        carbs_total: newCarbs,
        timing_minutes: newTiming,
      };
    }
    return item;
  }).filter(item => item.quantity > 0); // Remove items with 0 quantity

  setPlan(recalculatePlan(updated, targetCarbs));
};

// Add product to plan
const handleAddProduct = (product: FuelProduct) => {
  const existing = plan.items.find(item => item.fuel_product_id === product.id);
  if (existing) {
    handleQuantityChange(product.id, 1);
  } else {
    const newItem: FuelPlanItem = {
      fuel_product_id: product.id,
      product_name: product.name,
      quantity: 1,
      carbs_per_serving: product.carbs_per_serving,
      timing_minutes: generateTiming(durationMinutes, 1),
      carbs_total: product.carbs_per_serving,
    };
    setPlan(recalculatePlan([...plan.items, newItem], targetCarbs));
  }
};

// Confirm and navigate to Story 4.3
const handleConfirmPlan = () => {
  navigation.navigate('SessionConfirm', {
    sessionId,
    plan,
  });
};
```

**UI Structure:**
```typescript
<ScrollView>
  {/* Summary Card */}
  <Card>
    <Text>Totalt: {plan.total_carbs}g ({plan.percentage}%)</Text>
    <Text>Mål: {plan.target_carbs}g</Text>
    <ProgressBar value={plan.percentage / 100} />
  </Card>

  {/* Plan Items */}
  {plan.items.map(item => (
    <Card key={item.fuel_product_id}>
      <Text>{item.product_name}</Text>
      <Text>{item.carbs_total}g ({item.quantity} × {item.carbs_per_serving}g)</Text>
      <Text>Timing: {item.timing_minutes.join(', ')} min</Text>

      <View style={flexRow}>
        <IconButton icon="minus" onPress={() => handleQuantityChange(item.fuel_product_id, -1)} />
        <Text>{item.quantity}</Text>
        <IconButton icon="plus" onPress={() => handleQuantityChange(item.fuel_product_id, 1)} />
        <IconButton icon="delete" onPress={() => handleQuantityChange(item.fuel_product_id, -item.quantity)} />
      </View>
    </Card>
  ))}

  {/* Available Products (not in plan) */}
  <Text>Legg til produkter:</Text>
  {availableProducts
    .filter(p => !plan.items.find(item => item.fuel_product_id === p.id))
    .map(product => (
      <Card key={product.id} onPress={() => handleAddProduct(product)}>
        <Text>{product.name} ({product.carbs_per_serving}g)</Text>
      </Card>
    ))}

  {/* Confirm Button */}
  <Button mode="contained" onPress={handleConfirmPlan}>
    Bekreft plan
  </Button>
</ScrollView>
```

### Edge Cases

**Empty Skafferi:**
```typescript
if (availableProducts.length === 0) {
  return (
    <EmptyState
      icon="food-off"
      message="Du har ingen produkter i skafferiet"
      actionLabel="Gå til skafferi"
      onAction={() => navigation.navigate('Skafferi')}
    />
  );
}
```

**No Valid Plan (all products too large):**
- Show warning if plan.percentage < 50% or > 150%
- Suggest adding more products to skafferi

### SessionPlanScreen Update

**Replace handleCreatePlan (line 71-74):**
```typescript
const handleCreatePlan = () => {
  navigation.navigate('FuelSelector', {
    sessionId,
    targetCarbs: calculateTotalCarbs(),
    durationMinutes: session!.duration_minutes,
  });
};
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story | Bob (SM) |
| 2025-10-27 | 1.1 | Refined scope to clarify relationship to Story 4.1. AC5 (plan acceptance) deferred to Story 4.3. Expanded tasks from 8 to 18 detailed items. Added comprehensive Dev Notes with navigation types, FuelPlan types, complete fuelPlanner service implementation, FuelSelectorScreen component structure, edge case handling, and SessionPlanScreen update. Status changed to Ready for Development. | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
