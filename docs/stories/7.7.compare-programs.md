# Story 7.7: Sammenlign programmer (NEW)

## Status
**Draft**

## Story
**As a** user who has completed multiple programs, **I want** to compare my progression between programs, **so that** I can see which protocol works best for me.

## Acceptance Criteria
1. Analyse-skjerm har "Sammenlign programmer"-fane
2. Liste over fullførte programmer (minst 50% gjennomført) med checkboxes
3. Bruker velger 2-3 programmer → Trykk "Sammenlign"
4. Sammenligningsgraf vises: X-akse (økt-nummer eller % av program), Y-akse (ubehag nivå), Flere linjer (en per program, ulike farger)
5. Tabell under graf: Program, Økter, Gj.snitt ubehag, Gj.snitt rate, Suksessrate (økter med ubehag < 3)
6. Insight-kort: "✅ 4-Week Base hadde lavest ubehag (1.2/5 vs 2.8/5)"

## Tasks / Subtasks
- [ ] Create `src/screens/analysis/CompareProgramsScreen.tsx`
- [ ] Create `src/components/analysis/ComparisonChart.tsx`
- [ ] Query completed/active programs (≥50% done)
- [ ] Allow multi-select (2-3 programs)
- [ ] Query comparison data for selected programs (ProgramRepository.getComparisonData)
- [ ] Normalize data (different program lengths)
- [ ] Implement multi-series Victory Native chart
- [ ] Display comparison table with stats
- [ ] Generate insight card (lowest discomfort program)
- [ ] Test with 2 completed programs

## Dev Notes
**Normalization:** Programs have different lengths (4 weeks vs 6 weeks). Normalize X-axis to session number (1-N) or percentage (0-100%).

**Comparison Query:**
```sql
-- For each selected program
SELECT
  ps.session_number,
  AVG(CASE WHEN se.event_type = 'discomfort' THEN JSON_EXTRACT(se.data_json, '$.level') END) AS avg_discomfort,
  (SUM(CASE WHEN se.event_type = 'intake' THEN JSON_EXTRACT(se.data_json, '$.carbs_consumed') ELSE 0 END) / sl.duration_actual_minutes) * 60 AS actual_rate
FROM program_sessions ps
LEFT JOIN planned_sessions pls ON pls.program_session_id = ps.id
LEFT JOIN session_logs sl ON sl.planned_session_id = pls.id AND sl.session_status = 'completed'
LEFT JOIN session_events se ON se.session_log_id = sl.id
WHERE ps.program_id = ?
GROUP BY ps.session_number
ORDER BY ps.session_number;
```

**Chart:**
```typescript
<VictoryChart>
  {programs.map((program, idx) => (
    <VictoryLine
      key={program.id}
      data={program.dataPoints}
      style={{data: {stroke: COLORS[idx]}}}
    />
  ))}
  <VictoryLegend data={programs.map(p => ({name: p.name, symbol: {fill: p.color}}))} />
</VictoryChart>
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | NEW story based on user feedback | Bob (SM) |

## Dev Agent Record
*To be filled*

## QA Results
*To be filled*
